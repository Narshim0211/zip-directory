version: '3.8'

services:
  # Main Backend - Authentication Gateway & Proxy
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: salonhub-backend
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGO_URI=${BACKEND_MONGO_URI}
      - JWT_SECRET=${JWT_SECRET}
      - PROFILE_SERVICE_URL=http://profile-service:6001
      - BOOKING_SERVICE_URL=http://booking-service:6002
      - PAYMENT_SERVICE_URL=http://payment-service:6003
    depends_on:
      - profile-service
      - booking-service
      - payment-service
    networks:
      - salonhub-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Profile Microservice
  profile-service:
    build:
      context: ./services/profile-service
      dockerfile: Dockerfile
    container_name: salonhub-profile
    ports:
      - "6001:6001"
    environment:
      - NODE_ENV=production
      - PORT=6001
      - MONGO_URI=${PROFILE_MONGO_URI}
      - MAIN_BACKEND_URL=http://backend:5000
      - CORS_ORIGIN=${WEB_ORIGIN}
    networks:
      - salonhub-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Booking Microservice
  booking-service:
    build:
      context: ./services/booking-service
      dockerfile: Dockerfile
    container_name: salonhub-booking
    ports:
      - "6002:6002"
    environment:
      - NODE_ENV=production
      - PORT=6002
      - MONGO_URI=${BOOKING_MONGO_URI}
      - MAIN_BACKEND_URL=http://backend:5000
      - CORS_ORIGIN=${WEB_ORIGIN}
    networks:
      - salonhub-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Payment Microservice
  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: salonhub-payment
    ports:
      - "6003:6003"
    environment:
      - NODE_ENV=production
      - PORT=6003
      - MONGO_URI=${PAYMENT_MONGO_URI}
      - MAIN_BACKEND_URL=http://backend:5000
      - CORS_ORIGIN=${WEB_ORIGIN}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - BASIC_PLAN_ID=${BASIC_PLAN_ID}
      - PREMIUM_PLAN_ID=${PREMIUM_PLAN_ID}
      - DEPOSIT_PERCENTAGE=25
    networks:
      - salonhub-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend (Optional - if you want to run it in Docker)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: salonhub-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5000
    depends_on:
      - backend
    networks:
      - salonhub-network
    restart: unless-stopped

networks:
  salonhub-network:
    driver: bridge

# Usage:
# 1. Create .env file with required variables:
#    BACKEND_MONGO_URI, PROFILE_MONGO_URI, BOOKING_MONGO_URI, PAYMENT_MONGO_URI
#    JWT_SECRET, WEB_ORIGIN, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET
#    BASIC_PLAN_ID, PREMIUM_PLAN_ID
#
# 2. Start all services:
#    docker-compose up -d
#
# 3. View logs:
#    docker-compose logs -f
#
# 4. Stop all services:
#    docker-compose down
#
# 5. Rebuild after code changes:
#    docker-compose up -d --build
